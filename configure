#!/usr/bin/env python
import optparse
import os
import pprint
import re
import shlex
import subprocess
import sys

# NOTE: we borrow from Node.js configure

root_dir = os.path.dirname(__file__)
build_dir = './build'

# Parse options
parser = optparse.OptionParser()
parser.add_option("--debug",
    action="store_true",
    dest="debug",
    help="Also build debug build")

(options, args) = parser.parse_args()

def write(filename, data):
  filename = os.path.join(root_dir, filename)
  print "creating ", filename
  f = open(filename, 'w+')
  f.write(data)

# config.mk
config = {
  'BUILDTYPE': 'Debug' if options.debug else 'Release',
  'PYTHON': sys.executable,
  'BUILD_DIR': build_dir
}
config = '\n'.join(map('='.join, config.iteritems())) + '\n'

# Create config
write('config.mk',
      '# Do not edit. Generated by the configure script.\n' + config)

# Check boost prerequisite
print "checking prerequisities"
subprocess.call(['./boost_prereq'])

# Gyp call
print "creating makefiles"
gyp_args = ['-f', 'make', '--generator-output', build_dir, '--depth', '.']
subprocess.call(['gyp'] + gyp_args)

# All done
print "All OK."