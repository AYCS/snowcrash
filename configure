#!/usr/bin/env python
import optparse
import os
import pprint
import re
import shlex
import subprocess
import sys
import platform

# NOTE: We borrow from Node.js configure,
# refer to https://github.com/joyent/node

root_dir = os.path.dirname(__file__)
build_dir = './build'

# Parse options
parser = optparse.OptionParser()
parser.add_option("--debug",
    action="store_true",
    dest="debug",
    help="Also build debug build")

(options, args) = parser.parse_args()

def write(filename, data):
  filename = os.path.join(root_dir, filename)
  print "creating ", filename
  f = open(filename, 'w+')
  f.write(data)

# config.mk
config = {
  'BUILDTYPE': 'Debug' if options.debug else 'Release',
  'PYTHON': sys.executable,
  'BUILD_DIR': build_dir
}
config = '\n'.join(map('='.join, config.iteritems())) + '\n'

# Create config
write('config.mk',
      '# Do not edit. Generated by the configure script.\n' + config)

# Gyp call
print "creating makefiles"

gyp_args = ['--generator-output', build_dir, '--depth', '.']
if sys.platform == 'win32':
  # Windows
  gyp_args.extend(['-f', 'msvs', '-G', 'msvs_version=2012'])
else:
  # Posix systems
  gyp_args.extend(['-f', 'make'])
  
subprocess.call([sys.executable, 'tools/gyp/gyp'] + gyp_args)

# All done
print "All OK."
